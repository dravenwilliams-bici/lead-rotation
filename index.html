<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phone Lead Indicator</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 16px;
    }
    .card {
      border-radius: 16px;
      padding: 24px 32px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      max-width: 380px;
      text-align: center;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 12px;
    }
    .name {
      font-size: 2rem;
      font-weight: 700;
      margin: 16px 0 8px;
    }
    .label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.7;
      margin-bottom: 4px;
    }
    button {
      margin-top: 8px;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
    }
    button:active {
      transform: scale(0.98);
    }
    .history {
      margin-top: 24px;
      font-size: 0.85rem;
      max-height: 200px;
      overflow-y: auto;
      text-align: left;
    }
    .history-entry {
      margin-bottom: 4px;
      opacity: 0.8;
    }
    .status {
      margin-top: 8px;
      font-size: 0.8rem;
      opacity: 0.7;
    }
    .auth {
      margin-bottom: 16px;
      width: 100%;
      max-width: 380px;
    }
    .auth input {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      margin: 4px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    .auth-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 8px;
    }
    .auth-status {
      font-size: 0.8rem;
      opacity: 0.8;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <!-- Simple email/password sign-in -->
  <div class="auth">
    <div id="authSignedOut">
      <div><strong>Sign in to use the lead indicator</strong></div>
      <input id="emailInput" type="email" placeholder="Email" autocomplete="username" />
      <input id="passwordInput" type="password" placeholder="Password" autocomplete="current-password" />
      <div class="auth-row">
        <button id="signInButton">Sign In</button>
      </div>
      <div class="auth-status" id="authStatusText"></div>
    </div>

    <div id="authSignedIn" style="display:none;">
      <div class="auth-status">
        Signed in as <span id="signedInEmail"></span>
      </div>
      <button id="signOutButton">Sign Out</button>
    </div>
  </div>

  <div class="card">
    <h1>Phone Lead Indicator</h1>
    <div class="subtitle">Next phone lead goes to:</div>
    <div class="name" id="currentName">Loading...</div>
    <div class="label" id="lastUpdated">Connecting…</div>
    <button id="toggleButton" disabled>Assign Lead & Switch</button>
    <div class="status" id="statusText"></div>

    <div class="history" id="history"></div>
  </div>

  <!-- Firebase + app logic -->
  <script type="module">
    // Import Firebase SDKs from the CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      onSnapshot,
      runTransaction,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAwZcpkH33b828fduDfrUNIKk0pXeZOskA",
      authDomain: "bici-lead-indicator.firebaseapp.com",
      projectId: "bici-lead-indicator",
      storageBucket: "bici-lead-indicator.firebasestorage.app",
      messagingSenderId: "226296375616",
      appId: "1:226296375616:web:17afb9c551a535478df2a5"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Rotation between Sean and Draven (Sean starts)
    const people = ["Sean", "Draven"];
    const stateDocRef = doc(db, "leadState", "phoneLead");

    // DOM elements
    const currentNameEl = document.getElementById("currentName");
    const lastUpdatedEl = document.getElementById("lastUpdated");
    const historyEl = document.getElementById("history");
    const toggleButton = document.getElementById("toggleButton");
    const statusText = document.getElementById("statusText");

    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");
    const signInButton = document.getElementById("signInButton");
    const signOutButton = document.getElementById("signOutButton");
    const authStatusText = document.getElementById("authStatusText");
    const authSignedOut = document.getElementById("authSignedOut");
    const authSignedIn = document.getElementById("authSignedIn");
    const signedInEmail = document.getElementById("signedInEmail");

    const MAX_HISTORY_STORED = 100;  // how many entries we keep in Firestore
    const MAX_HISTORY_DISPLAYED = 15; // how many we show on the page

    function formatTime(date) {
      return date.toLocaleString([], {
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function render(state) {
      currentNameEl.textContent = people[state.nextIndex];

      const history = state.history || [];

      if (history.length > 0) {
        const last = history[0];
        lastUpdatedEl.textContent = `Last lead: ${last.assignedTo} at ${last.time}`;
      } else {
        lastUpdatedEl.textContent = "No leads assigned yet.";
      }

      historyEl.innerHTML = "";
      history.slice(0, MAX_HISTORY_DISPLAYED).forEach(entry => {
        const div = document.createElement("div");
        div.className = "history-entry";
        div.textContent = `• ${entry.time} → ${entry.assignedTo}`;
        historyEl.appendChild(div);
      });
    }

    async function ensureInitialState() {
      const snap = await getDoc(stateDocRef);
      if (!snap.exists()) {
        await setDoc(stateDocRef, {
          nextIndex: 0,
          history: []
        });
      }
    }

    let firestoreInitialized = false;

    function startFirestore(user) {
      if (firestoreInitialized) return;
      firestoreInitialized = true;

      console.log("Firestore starting for", user.email);
      statusText.textContent = "Connecting to Firestore…";

      onSnapshot(
        stateDocRef,
        (snapshot) => {
          if (snapshot.exists()) {
            const data = snapshot.data();
            render(data);
            toggleButton.disabled = false;
            statusText.textContent = `Live: changes sync for everyone.`;
          } else {
            currentNameEl.textContent = "Setting up…";
            toggleButton.disabled = true;
          }
        },
        (error) => {
          console.error("Error listening to Firestore:", error);
          statusText.textContent = "Error connecting to server.";
        }
      );

      ensureInitialState().catch(err => {
        console.error("Error ensuring initial state:", err);
        statusText.textContent = "Error setting up state.";
      });

      toggleButton.addEventListener("click", async () => {
        toggleButton.disabled = true;
        statusText.textContent = "Updating…";

        try {
          await runTransaction(db, async (transaction) => {
            const snap = await transaction.get(stateDocRef);
            let data;
            if (!snap.exists()) {
              data = { nextIndex: 0, history: [] };
            } else {
              data = snap.data();
            }

            const assignedTo = people[data.nextIndex];
            const nowStr = formatTime(new Date());
            const existingHistory = data.history || [];

            const newHistory = [
              { assignedTo, time: nowStr },
              ...existingHistory
            ].slice(0, MAX_HISTORY_STORED);

            const newNextIndex = (data.nextIndex + 1) % people.length;

            transaction.set(stateDocRef, {
              nextIndex: newNextIndex,
              history: newHistory
            });
          });

          statusText.textContent = "Updated!";
        } catch (err) {
          console.error("Transaction failed: ", err);
          statusText.textContent = "Update failed, please try again.";
        } finally {
          toggleButton.disabled = false;
        }
      });
    }

    // Handle sign-in form submit
    signInButton.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value;

      if (!email || !password) {
        authStatusText.textContent = "Please enter email and password.";
        return;
      }

      authStatusText.textContent = "Signing in…";
      try {
        await signInWithEmailAndPassword(auth, email, password);
        // onAuthStateChanged will handle the rest
      } catch (err) {
        console.error("Sign-in error:", err);
        let msg = "Sign-in failed.";
        if (err.code === "auth/wrong-password") msg = "Wrong password.";
        else if (err.code === "auth/user-not-found") msg = "User not found.";
        else if (err.code === "auth/invalid-email") msg = "Invalid email.";
        authStatusText.textContent = msg;
      }
    });

    // Handle sign-out
    signOutButton.addEventListener("click", async () => {
      await signOut(auth);
    });

    // React to auth state changes
    onAuthStateChanged(auth, (user) => {
      if (user) {
        authSignedOut.style.display = "none";
        authSignedIn.style.display = "block";
        signedInEmail.textContent = user.email || "(no email)";
        authStatusText.textContent = "";
        startFirestore(user);
      } else {
        authSignedOut.style.display = "block";
        authSignedIn.style.display = "none";
        signedInEmail.textContent = "";
        statusText.textContent = "Sign in to use the lead indicator.";
        toggleButton.disabled = true;
      }
    });
  </script>
</body>
</html>
